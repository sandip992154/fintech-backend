â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    WALLET TOPUP - COMPLETE FLOW DIAGRAM                          â•‘
â•‘                     Frontend â†’ Backend â†’ Database â†’ Response                      â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•


1. USER CLICKS "ADD FUNDS" BUTTON
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

SuperAdmin Dashboard (Header.jsx)
       â†“
   [Add Funds Button]
       â†“ onClick
   LoadWalletModal Opens
       â†“
   User enters:
   - Amount: 500 (â‚¹)
   - Remark: "Monthly salary"
   - Click "Add Funds"


2. FRONTEND VALIDATION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

LoadWalletModal.jsx (handleSubmit)
    â†“
validateForm()
    â”œâ”€ Amount required? âœ…
    â”œâ”€ Amount > 0? âœ…
    â”œâ”€ Amount is number? âœ…
    â””â”€ Remark â‰¤ 500 chars? âœ…


3. API REQUEST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

walletService.topupWallet(userId=1, {amount: 500, remark: "Monthly salary"})
    â†“
apiClient.post('/transactions/wallet/topup/1', {
    amount: 500.0,
    remark: "Monthly salary"
})
    â†“

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                            ğŸŒ NETWORK REQUEST                                  â•‘
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â•‘  POST /api/v1/transactions/wallet/topup/1                                       â•‘
â•‘                                                                                  â•‘
â•‘  Headers:                                                                        â•‘
â•‘    Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...                â•‘
â•‘    Content-Type: application/json                                               â•‘
â•‘                                                                                  â•‘
â•‘  Body:                                                                           â•‘
â•‘    {                                                                             â•‘
â•‘      "amount": 500.0,                                                            â•‘
â•‘      "remark": "Monthly salary"                                                  â•‘
â•‘    }                                                                             â•‘
â•‘                                                                                  â•‘
â•‘  Target: http://localhost:8000 (dev) / Render URL (prod)                        â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•


4. BACKEND RECEIVES REQUEST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

transaction.py â†’ topup_wallet()
    â†“
@router.post("/wallet/topup/{user_id}")
async def topup_wallet(
    user_id: int = 1,
    current_user: User = Depends(get_current_user),  â† Auth check
    db: Session = Depends(get_db),                    â† DB connection
    data: WalletTopupRequest = Body(...)              â† Request body
)


5. AUTHENTICATION VERIFICATION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

get_current_user(token)
    â†“
    â”œâ”€ Decode JWT token
    â”œâ”€ Extract user_code and user_id
    â”œâ”€ Query: SELECT * FROM users WHERE user_code = ?
    â””â”€ Return: User(id=1, email="admin@...")
        â†“
    âœ… Authenticated â†’ Continue


6. REQUEST PARSING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

WalletTopupRequest validation:
    â”œâ”€ amount: 500.0 (float)
    â”œâ”€ remark: "Monthly salary" (string)
    â””â”€ Pydantic validation: âœ… Valid


7. BACKEND PROCESSING - THE FIX
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

try:
    â”œâ”€ Step 1: Convert to float âœ…
    â”‚   amount_float = float(500.0) = 500.0
    â”‚
    â”œâ”€ Step 2: Validate amount âœ…
    â”‚   â”œâ”€ 500 > 0? YES
    â”‚   â”œâ”€ 500 â‰¤ 100000? YES
    â”‚   â””â”€ Valid decimal format? YES
    â”‚
    â”œâ”€ Step 3: Get or create wallet âœ…
    â”‚   wallet = db.query(Wallet).filter(Wallet.user_id == 1).first()
    â”‚   
    â”‚   if not wallet:
    â”‚       wallet = Wallet(user_id=1, balance=0.0, is_active=True)
    â”‚       db.flush()
    â”‚   
    â”‚   Result: Wallet(id=1, balance=0.0)
    â”‚
    â”œâ”€ Step 4: Calculate new balance âœ…
    â”‚   current_balance = float(0.0) = 0.0
    â”‚   new_balance = 0.0 + 500.0 = 500.0
    â”‚
    â”œâ”€ Step 5: Validate final balance âœ…
    â”‚   500.0 â‰¤ 500000? YES âœ“
    â”‚
    â”œâ”€ Step 6: Create transaction record âœ…
    â”‚   reference_id = "TOPUP-A7F3B2C1"
    â”‚   
    â”‚   wallet_txn = WalletTransaction(
    â”‚       wallet_id=1,
    â”‚       amount=500.0,           â† Float âœ…
    â”‚       transaction_type="credit",
    â”‚       reference_id="TOPUP-A7F3B2C1",
    â”‚       remark="Monthly salary",
    â”‚       balance_after=500.0     â† Float âœ…
    â”‚   )
    â”‚
    â”œâ”€ Step 7: Update wallet âœ…
    â”‚   wallet.balance = 500.0
    â”‚   wallet.last_updated = datetime.utcnow()
    â”‚
    â”œâ”€ Step 8: Save to database âœ…
    â”‚   db.add(wallet_txn)
    â”‚   db.flush()
    â”‚   db.commit()
    â”‚   db.refresh(wallet)
    â”‚
    â””â”€ Step 9: Log success âœ…
        logger.info("âœ… Wallet topup successful...")

except SQLAlchemyError as e:
    db.rollback()
    logger.error("Database error...", exc_info=True)
    raise HTTPException(500, {"error": "database_error"})

except (InvalidOperation, ValueError, TypeError) as e:
    logger.error("Invalid data type...", exc_info=True)
    raise HTTPException(400, {"error": "validation_error"})

except Exception as e:
    db.rollback()
    logger.error("Unexpected error...", exc_info=True)
    raise HTTPException(500, {"error": "server_error"})


8. DATABASE OPERATIONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Transaction 1: Create/Update Wallet
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ UPDATE wallets SET                  â”‚
â”‚   balance = 500.0,                  â”‚
â”‚   last_updated = NOW()              â”‚
â”‚ WHERE user_id = 1                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
           âœ… 1 row affected

Transaction 2: Insert Transaction Record
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ INSERT INTO wallet_transactions     â”‚
â”‚   (wallet_id, amount, ....) VALUES  â”‚
â”‚   (1, 500.0, 'credit', ...)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
           âœ… 1 row inserted

Commit both transactions atomically
              â†“
           âœ… Database updated


9. BUILD RESPONSE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

{
    "success": true,
    "message": "Wallet topped up successfully",
    "data": {
        "id": 1,                    â† wallet.id
        "user_id": 1,               â† wallet.user_id
        "balance": 500.0,           â† wallet.balance (updated)
        "transaction_id": "TOPUP-A7F3B2C1",  â† reference_id
        "amount_added": 500.0,      â† topup amount
        "remark": "Monthly salary", â† user remark
        "last_updated": "2026-02-15T22:30:45.123456"
    }
}


10. RESPONSE SENT TO FRONTEND
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

HTTP/1.1 200 OK
Content-Type: application/json

{
    "success": true,
    "message": "Wallet topped up successfully",
    "data": {...}
}


11. FRONTEND HANDLES SUCCESS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

LoadWalletModal.jsx (handleSubmit)
    â†“
if (result.success) {
    â”œâ”€ Toast: "â‚¹500.00 added to wallet successfully!" âœ…
    â”œâ”€ Clear form fields
    â”œâ”€ Dispatch event: window.dispatchEvent(new Event("walletUpdated"))
    â”‚   â””â”€ Triggers refresh in other components
    â”œâ”€ Call onSuccess callback
    â””â”€ Close modal
}


12. OTHER COMPONENTS REFRESH
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

MyWallet.jsx listens for "walletUpdated" event
    â†“
window.addEventListener("walletUpdated", handleWalletUpdated)
    â†“
handleWalletUpdated() {
    â”œâ”€ Increment refreshTrigger
    â””â”€ Pass to child components
}
    â†“
    â”œâ”€ WalletBalanceCard
    â”‚   â”œâ”€ useEffect triggered by refreshTrigger
    â”‚   â”œâ”€ Fetch: GET /api/v1/transactions/wallet/1
    â”‚   â””â”€ Display new balance: â‚¹500.0 âœ…
    â”‚
    â””â”€ WalletHistory
        â”œâ”€ useEffect triggered by refreshTrigger
        â”œâ”€ Fetch: GET /api/v1/transactions/wallet/1/transactions
        â””â”€ Display transactions with new entry âœ…


13. TRANSACTION HISTORY DISPLAY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Transaction List:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Type   â”‚ Amount  â”‚ Remark        â”‚ Balance â”‚ Date/Time       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Credit â”‚ â‚¹500.00 â”‚ Monthly salaryâ”‚ â‚¹500.00 â”‚ 15 Feb, 22:30  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
        âœ… Fully functional transaction history


14. FINAL STATE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

User sees:
âœ… Success notification: "â‚¹500.00 added to wallet successfully!"
âœ… Modal closes automatically
âœ… Dashboard updates:
   â”œâ”€ Wallet Balance Card: â‚¹500.00
   â””â”€ Transaction History: New entry with date/time/remark
âœ… Everything works!


ERROR HANDLING - WHEN THINGS GO WRONG
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Scenario: User sends invalid amount (e.g., -100)

Step 1: Backend validates
    amount_float = -100.0
    if amount_float <= 0: (TRUE)
        raise ValidationError(400, {
            "error": "validation_error",
            "message": "Invalid topup amount",
            "details": {...}
        })

Step 2: Frontend receives error (400)
    if (result.success) { ... }
    else {
        toast.error(result.message || "Failed to load wallet")
    }

Step 3: User sees
    âŒ Toast: "Invalid topup amount"
    Modal stays open
    User can correct and try again


COMPLETE DATA FLOW SUMMARY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

User Input
    â†“
Frontend Validation
    â†“
API Request (POST /wallet/topup/{user_id})
    â†“
Backend Auth Check (JWT)
    â†“
Backend Input Parsing (WalletTopupRequest)
    â†“
Backend Processing (Convert to Float, Validate, Calculate)
    â†“
Database Insert (WalletTransaction)
    â†“
Database Update (Wallet.balance)
    â†“
API Response (200 OK)
    â†“
Frontend Success Handler
    â†“
Event Dispatch ("walletUpdated")
    â†“
Child Components Refresh
    â†“
Display Updated Balance & Transaction History
    â†“
âœ… USER SEES RESULTS IMMEDIATELY


WHAT MAKES THIS IMPLEMENTATION PROFESSIONAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ… Type Safety      â†’ No Decimal/Float conflicts
âœ… Error Handling   â†’ Specific errors for each scenario
âœ… Logging          â†’ Full stack traces for debugging
âœ… Validation       â†’ Multi-layer validation (client + server)
âœ… Atomicity        â†’ Transactions succeed or fail completely
âœ… Consistency      â†’ All data stays in sync
âœ… Performance      â†’ Efficient database queries
âœ… Security        â†’ JWT authentication required
âœ… Scalability      â†’ Works locally and on Render production
âœ… Maintainability  â†’ Clean, documented, extensible code


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                              âœ… COMPLETE FLOW
                         No more 500 errors! Problem solved!
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
